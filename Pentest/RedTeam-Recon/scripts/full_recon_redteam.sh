
---

#### 2. `scripts/full_recon_redteam.sh`

```bash
#!/bin/bash
# Red Team Full Initial Recon Script (自分のIPベースLAN判定)

TARGET="$1"
OUTPUT_DIR="${TARGET}_recon_results"

if [ -z "$TARGET" ]; then
    echo "Usage: $0 <target IP or domain>"
    exit 1
fi

mkdir -p "$OUTPUT_DIR"

# 自分のIPとサブネット取得（eth0の場合）
MY_IP=$(ip -o -4 addr show eth0 | awk '{print $4}' | cut -d/ -f1)
MY_NETMASK=$(ip -o -4 addr show eth0 | awk '{print $4}' | cut -d/ -f2)

# IPを整数に変換
ip2dec() {
    local IFS=.
    read -r i1 i2 i3 i4 <<< "$1"
    echo $((i1*256**3 + i2*256**2 + i3*256 + i4))
}

MY_DEC=$(ip2dec "$MY_IP")
TARGET_DEC=$(ip2dec "$TARGET")
NETMASK_DEC=$(( 0xFFFFFFFF << (32 - MY_NETMASK) & 0xFFFFFFFF ))

# LAN判定（同一サブネットかどうか）
if (( (MY_DEC & NETMASK_DEC) == (TARGET_DEC & NETMASK_DEC) )); then
    LAN_FLAG=true
else
    LAN_FLAG=false
fi

echo "[*] Target: $TARGET"
echo "[*] LAN target (same subnet as self): $LAN_FLAG"
echo "[*] Results folder: $OUTPUT_DIR"

# ホスト生存確認
echo "[*] Checking host alive..."
if ping -c 2 -W 1 $TARGET &>/dev/null; then
    echo "Host is up (ICMP ping)"
else
    echo "Host may be up (ICMP blocked), trying TCP ping..."
    nc -z -v -w 2 $TARGET 80 &>/dev/null && echo "TCP ping on port 80: Host is up" || echo "TCP ping failed"
fi

# Nmap全ポートスキャン + OS/サービス検出
NMAP_OPTS="-g53 --max-retries=1 -Pn -p- -sS -sV -O -T2 --scan-delay 200ms -oN $OUTPUT_DIR/nmap_full.txt"
[ "$LAN_FLAG" = true ] && NMAP_OPTS="$NMAP_OPTS --disable-arp-ping"

echo "[*] Running Nmap full port scan..."
nmap $NMAP_OPTS $TARGET

# Webサービス確認
for PORT in 80 443; do
    echo "[*] Checking HTTP/S port $PORT..."
    curl -I --max-time 10 http://$TARGET:$PORT 2>/dev/null > "$OUTPUT_DIR/web_${PORT}.txt"
    curl -I --max-time 10 https://$TARGET:$PORT 2>/dev/null >> "$OUTPUT_DIR/web_${PORT}.txt"
done

# SMB情報収集
echo "[*] Collecting SMB shares and users..."
smbclient -L //$TARGET -N 2>/dev/null > "$OUTPUT_DIR/smb_shares.txt"
rpcclient -U "" $TARGET 2>/dev/null > "$OUTPUT_DIR/smb_users.txt"

# LDAP匿名バインド確認
echo "[*] Checking LDAP anonymous bind..."
ldapsearch -x -h $TARGET -s base > "$OUTPUT_DIR/ldap_anonymous.txt" 2>/dev/null

# Traceroute
echo "[*] Running traceroute..."
traceroute -n $TARGET > "$OUTPUT_DIR/traceroute.txt"

# LAN内ならARPスキャン
if [ "$LAN_FLAG" = true ]; then
    echo "[*] Running ARP scan on local subnet..."
    arp-scan --localnet > "$OUTPUT_DIR/arp_scan.txt" 2>/dev/null
fi

# DNS情報収集
echo "[*] Collecting DNS info..."
dig @$TARGET $TARGET ANY > "$OUTPUT_DIR/dns_any.txt" 2>/dev/null
whois $TARGET > "$OUTPUT_DIR/whois.txt" 2>/dev/null

echo "[*] Full initial recon completed. Results saved in $OUTPUT_DIR/"
